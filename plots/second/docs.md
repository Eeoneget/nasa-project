
# Документация к коду PACE Chlorophyll-a (OC4 proxy)

## 1. Назначение

Этот код выполняет следующие задачи:

1. Доступ к спутниковым данным **PACE L2** через API `earthaccess`.
2. Вычисление концентрации хлорофилла-a в океане с использованием алгоритма **OC4V6**.
3. Сбор данных из нескольких гранул (орбитальных снимков) за заданный период.
4. Визуализация пространственного распределения хлорофилла на карте.
5. Подготовка графиков для анализа изменений концентрации хлорофилла.

---

## 2. Используемые библиотеки

| Библиотека          | Назначение                                                 |
| ------------------- | ---------------------------------------------------------- |
| `earthaccess`       | Доступ к данным NASA PACE (поиск и скачивание)             |
| `h5netcdf`          | Чтение файлов формата NetCDF/HDF5                          |
| `numpy`             | Математические операции с массивами                        |
| `matplotlib.pyplot` | Визуализация данных (графики)                              |
| `cartopy.crs`       | Географические проекции для карт                           |
| `cartopy.feature`   | Отображение берегов, суши и других географических объектов |

---

## 3. Структура кода

### 3.1 Авторизация

```python
earthaccess.login()
```

* Осуществляется один раз перед скачиванием данных.
* Требует учетной записи Earthdata NASA.

---

### 3.2 Функция `compute_chlor_oc4(rrs, wavelengths)`

* **Вход:**

  * `rrs` — отражение воды на разных длинах волн (массив `Rrs`).
  * `wavelengths` — массив длин волн, соответствующих каналам `Rrs`.
* **Выход:**

  * `chl` — массив концентрации хлорофилла (mg/m³).
* **Метод:**

  * Вычисляет переменную `R` через соотношение отражений на 443, 490, 510 и 555 нм.
  * Применяет полиномиальный алгоритм OC4V6 для расчета концентрации хлорофилла.

---

### 3.3 Функция `get_pace_oc4(short_name, temporal, bbox, max_granules=5)`

* **Назначение:** загрузка данных PACE L2 за период и регион, расчет хлорофилла.
* **Параметры:**

  * `short_name` — идентификатор датасета (например, `"PACE_OCI_L2_AOP_NRT"`).
  * `temporal` — кортеж дат (`start_date`, `end_date`), например `("2025-09-08", "2025-09-14")`.
  * `bbox` — прямоугольник координат (`lon_min, lat_min, lon_max, lat_max`).
  * `max_granules` — максимальное число файлов для скачивания.
* **Выход:** кортеж `(lat, lon, chl)`:

  * `lat` — широта каждой точки.
  * `lon` — долгота каждой точки.
  * `chl` — значение концентрации хлорофилла для каждой точки.
* **Особенности:**

  * Конкатенирует все гранулы.
  * Пропускает NaN значения.
  * Выводит статистику (`mean`, `min`, `max`) для каждой гранулы.

---

### 3.4 Параметры анализа

```python
temporal = ("2025-09-08", "2025-09-14")
bbox = (-160, -10, -120, 10)  # Экваториальная зона Тихого океана (El Niño)
max_granules = 5
```

* Задает временной интервал и регион интереса.
* Ограничение на количество гранул предотвращает скачивание слишком большого объема данных.

---

### 3.5 Визуализация

```python
plt.figure(figsize=(12,6))
ax = plt.axes(projection=ccrs.PlateCarree())
sc = ax.scatter(lon, lat, c=chl, s=1, cmap="viridis", vmin=0, vmax=5)
ax.coastlines()
ax.add_feature(cfeature.LAND, facecolor="lightgray")
plt.colorbar(sc, label="Chlorophyll-a proxy (mg/m³)")
plt.title("PACE Chlorophyll-a (OC4 proxy, Pacific)")
plt.show()
```

* Строит **точечную карту** хлорофилла по координатам.
* Цвет точек соответствует концентрации хлорофилла (mg/m³).
* Добавлены:

  * Берега (`ax.coastlines()`)
  * Суша (`cfeature.LAND`) светло-серым цветом.
* Настройки цвета: от 0 до 5 mg/m³ (`vmin=0, vmax=5`).

---

## 4. Результаты графиков

1. **Scatter Map (PACE Chlorophyll-a)**

   * Отображает распределение концентрации хлорофилла на выбранной территории.
   * Цветовая шкала: `viridis` (темно-синий — низкая концентрация, желто-зеленый — высокая).
   * Используется для анализа биологической активности океана и обнаружения зон роста фитопланктона.

2. **Возможные улучшения визуализации:**

   * Усреднение по дню или неделе.
   * Интерполяция точек на сетку для получения непрерывной карты.
   * Добавление побережья стран или других географических слоёв (`cfeature.BORDERS`).

---

## 5. Ограничения

* Данные PACE L2 — это отдельные орбитальные гранулы. Код **не усредняет** данные по времени или пространству.
* Для недельного усреднения или построения регулярной сетки нужно добавить агрегацию.
* Максимальное число гранул (`max_granules`) ограничивает полноту покрытия.


